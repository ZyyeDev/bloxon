[gd_scene load_steps=18 format=3 uid="uid://ce5bdp5lcqap1"]

[ext_resource type="PackedScene" uid="uid://yo6lqoksa53k" path="res://addons/naejimer_3d_planet_generator/scenes/planet_terrestrial.tscn" id="1_8jvpv"]
[ext_resource type="Texture2D" uid="uid://cpqrrjm00e5qh" path="res://assets/images/sky/spaceSkybox.png" id="1_wpb3d"]
[ext_resource type="PackedScene" uid="uid://c1lxtdgeggnej" path="res://addons/naejimer_3d_planet_generator/scenes/star.tscn" id="3_i6sp0"]
[ext_resource type="Texture2D" uid="uid://cibk77bly18d1" path="res://assets/images/sky/earth.jpg" id="3_qum32"]
[ext_resource type="ArrayMesh" uid="uid://bmnw0lpbgpivc" path="res://assets/models/menuBg/station/station.obj" id="4_qum32"]

[sub_resource type="GDScript" id="GDScript_tuxge"]
script/source = "extends Node3D

@export var sunRotator:Node3D
@export var stationRotator:Node3D
@export var ringRotator:Node3D

@export var planet:Node3D

func _ready() -> void:
	planet.rotation = Vector3(0,250,0)

func _physics_process(delta: float) -> void:
	stationRotator.rotate(Vector3(0,1,0),.0008)
	#ringRotator.rotate(Vector3(0,1,0),.00000001)
	
	planet.rotate(Vector3(0,1,0),.0005)
	sunRotator.rotate(Vector3(0,1,0),.00005)
"

[sub_resource type="Shader" id="Shader_i6sp0"]
code = "shader_type spatial;
render_mode unshaded, cull_disabled, depth_draw_opaque, blend_mix;

// Main parameters
uniform float scale : hint_range(0.1, 10.0) = 3.0;
uniform float quantization_steps : hint_range(2.0, 64.0) = 16.0;
uniform float ring_frequency : hint_range(0.5, 20.0) = 5.0;
uniform float ring_sharpness : hint_range(0.1, 5.0) = 2.0;

// Ring shape parameters
uniform float inner_radius : hint_range(0.0, 1000.0) = 430.0;
uniform float outer_radius : hint_range(0.0, 1000.0) = 550.0;
uniform float edge_softness : hint_range(0.0, 50.0) = 10.0;

// Animation
uniform float rotation_speed : hint_range(-2.0, 2.0) = 0.02;
uniform float time_scale : hint_range(0.0, 2.0) = 0.1;

// Saturn-inspired color gradient (from outer to inner rings)
uniform vec4 color_1 : source_color = vec4(0.18, 0.15, 0.12, 1.0); // Dark brown
uniform vec4 color_2 : source_color = vec4(0.65, 0.55, 0.45, 1.0); // Light tan
uniform vec4 color_3 : source_color = vec4(0.45, 0.38, 0.30, 1.0); // Medium brown
uniform vec4 color_4 : source_color = vec4(0.82, 0.72, 0.58, 1.0); // Pale gold
uniform vec4 color_5 : source_color = vec4(0.25, 0.22, 0.18, 1.0); // Dark band

// Detail noise parameters
uniform float noise_strength : hint_range(0.0, 1.0) = 0.3;
uniform float noise_scale : hint_range(0.1, 10.0) = 3.0;
uniform float detail_frequency : hint_range(1.0, 50.0) = 15.0;

// Edge glow
uniform float edge_glow : hint_range(0.0, 2.0) = 0.5;
uniform vec4 edge_color : source_color = vec4(0.9, 0.8, 0.6, 1.0);

// Quantize function
float quantize(float value, float steps) {
    return floor(value * steps) / steps;
}

// Simple 2D noise function
float hash(vec2 p) {
    p = fract(p * vec2(443.897, 441.423));
    p += dot(p, p + 19.19);
    return fract(p.x * p.y);
}

float noise2d(vec2 p) {
    vec2 i = floor(p);
    vec2 f = fract(p);
    f = f * f * (3.0 - 2.0 * f);
    
    float a = hash(i);
    float b = hash(i + vec2(1.0, 0.0));
    float c = hash(i + vec2(0.0, 1.0));
    float d = hash(i + vec2(1.0, 1.0));
    
    return mix(mix(a, b, f.x), mix(c, d, f.x), f.y);
}

// Rotation matrix
mat2 rotate2d(float angle) {
    return mat2(vec2(cos(angle), -sin(angle)),
                vec2(sin(angle), cos(angle)));
}

varying vec3 local_position;

void vertex() {
    // Store local position for fragment shader
    local_position = VERTEX;
}

void fragment() {
    // Use the local vertex position directly
    vec2 radial_pos = local_position.xz;
    float dist_from_center = length(radial_pos);
    
    // Create ring mask (discard pixels outside the ring)
    float ring_mask = smoothstep(inner_radius - edge_softness, inner_radius, dist_from_center) * 
                      smoothstep(outer_radius + edge_softness, outer_radius, dist_from_center);
    
    // If outside the ring, discard or make transparent
    if (ring_mask < 0.01) {
        discard;
    }
    
    // Normalize distance within the ring for effects
    float normalized_dist = (dist_from_center - inner_radius) / (outer_radius - inner_radius);
    float dist = normalized_dist * scale;
    
    // Calculate angle and apply rotation
    float base_angle = atan(radial_pos.y, radial_pos.x);
    float angle = base_angle + TIME * rotation_speed * time_scale;
    vec2 rotated_pos = vec2(cos(angle), sin(angle)) * dist_from_center;
    
    // Create ring pattern
    float rings = sin(dist * ring_frequency) * 0.5 + 0.5;
    rings = pow(rings, ring_sharpness);
    
    // Add detail noise
    vec2 noise_pos = rotated_pos * noise_scale * 0.01;
    float noise_val = noise2d(noise_pos + TIME * 0.1 * time_scale);
    
    // Add fine detail
    float detail = noise2d(radial_pos * detail_frequency * 0.01) * 0.5 + 0.5;
    
    // Combine patterns
    float pattern = rings + noise_val * noise_strength + detail * 0.2;
    
    // Quantize the pattern
    float quantized = quantize(pattern, quantization_steps);
    
    // Create color gradient based on distance and pattern
    float t = fract(quantized + dist * 0.3);
    
    vec4 final_color;
    if (t < 0.2) {
        final_color = mix(color_1, color_2, t / 0.2);
    } else if (t < 0.4) {
        final_color = mix(color_2, color_3, (t - 0.2) / 0.2);
    } else if (t < 0.6) {
        final_color = mix(color_3, color_4, (t - 0.4) / 0.2);
    } else if (t < 0.8) {
        final_color = mix(color_4, color_5, (t - 0.6) / 0.2);
    } else {
        final_color = mix(color_5, color_1, (t - 0.8) / 0.2);
    }
    
    // Add edge glow effect using view angle
    vec3 view_dir = normalize(VERTEX - CAMERA_POSITION_WORLD);
    float fresnel = pow(1.0 - abs(dot(NORMAL, view_dir)), 3.0);
    final_color = mix(final_color, edge_color, fresnel * edge_glow);
    
    // Apply ring mask to alpha
    final_color.a *= ring_mask;
    
    ALBEDO = final_color.rgb;
    ALPHA = final_color.a;
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_qum32"]
render_priority = 0
shader = SubResource("Shader_i6sp0")
shader_parameter/scale = 3.0
shader_parameter/quantization_steps = 16.0
shader_parameter/ring_frequency = 5.0
shader_parameter/ring_sharpness = 2.0
shader_parameter/inner_radius = 450.0
shader_parameter/outer_radius = 600.0
shader_parameter/edge_softness = 10.0
shader_parameter/rotation_speed = 0.2
shader_parameter/time_scale = 1.0
shader_parameter/color_1 = Color(0.18, 0.15, 0.12, 1)
shader_parameter/color_2 = Color(0.65, 0.55, 0.45, 1)
shader_parameter/color_3 = Color(0.45, 0.38, 0.3, 1)
shader_parameter/color_4 = Color(0.82, 0.72, 0.58, 1)
shader_parameter/color_5 = Color(0.25, 0.22, 0.18, 1)
shader_parameter/noise_strength = 0.3
shader_parameter/noise_scale = 3.0
shader_parameter/detail_frequency = 15.0
shader_parameter/edge_glow = 0.5
shader_parameter/edge_color = Color(0.9, 0.8, 0.6, 1)

[sub_resource type="PlaneMesh" id="PlaneMesh_qum32"]
material = SubResource("ShaderMaterial_qum32")
size = Vector2(2000, 2000)

[sub_resource type="PanoramaSkyMaterial" id="PanoramaSkyMaterial_8jvpv"]
panorama = ExtResource("1_wpb3d")

[sub_resource type="Sky" id="Sky_o2s3y"]
sky_material = SubResource("PanoramaSkyMaterial_8jvpv")

[sub_resource type="Environment" id="Environment_i6sp0"]
background_mode = 2
sky = SubResource("Sky_o2s3y")

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_tuxge"]
albedo_texture = ExtResource("3_qum32")

[sub_resource type="SphereMesh" id="SphereMesh_50vcd"]
material = SubResource("StandardMaterial3D_tuxge")

[sub_resource type="Animation" id="Animation_qum32"]
length = 0.001
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("PlanetTerrestrial/stationRotator:rotation")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector3(0, 0, 0)]
}

[sub_resource type="Animation" id="Animation_i6sp0"]
resource_name = "thing"
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("PlanetTerrestrial/stationRotator:rotation")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector3(0, 0, 0)]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_tuxge"]
_data = {
&"RESET": SubResource("Animation_qum32"),
&"thing": SubResource("Animation_i6sp0")
}

[node name="menuBg" type="Node3D" node_paths=PackedStringArray("sunRotator", "stationRotator", "ringRotator", "planet")]
script = SubResource("GDScript_tuxge")
sunRotator = NodePath("PlanetTerrestrial/SunRotator")
stationRotator = NodePath("PlanetTerrestrial/stationRotator")
ringRotator = NodePath("ringRotator")
planet = NodePath("PlanetTerrestrial")

[node name="ringRotator" type="Node3D" parent="."]
transform = Transform3D(168.934, 0, -362.576, 0, 400, 0, 362.576, 0, 168.934, -75.62, 131, 0)

[node name="MeshInstance3D" type="MeshInstance3D" parent="ringRotator"]
transform = Transform3D(-0.00126514, -5.39029e-07, 0.00141583, -0.000173683, 0.000222113, -9.90039e-05, -0.0017189, -2.20463e-05, -0.00103207, 0, 0, 0)
mesh = SubResource("PlaneMesh_qum32")
skeleton = NodePath("../..")

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_i6sp0")

[node name="PlanetTerrestrial" parent="." instance=ExtResource("1_8jvpv")]
transform = Transform3D(168.934, 0, -362.576, 0, 400, 0, 362.576, 0, 168.934, -75.62, 131, 0)
mesh = SubResource("SphereMesh_50vcd")

[node name="SunRotator" type="Node3D" parent="PlanetTerrestrial"]
transform = Transform3D(-0.00108654, 0, 0.00225154, 0, 0.0025, 0, -0.00225154, 0, -0.00108654, -0.101988, -0.3275, 0.15918)

[node name="Star" parent="PlanetTerrestrial/SunRotator" instance=ExtResource("3_i6sp0")]
transform = Transform3D(1188.33, 0, 166.996, 0, 1200, 0, -166.996, 0, 1188.33, 3658.05, 0, 0)
layers = 2
skeleton = NodePath("../../../..")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="PlanetTerrestrial/SunRotator"]
transform = Transform3D(-0.186329, 0, 0.982488, 0, 1, 0, -0.982488, 0, -0.186329, -109.814, 0, 67.0783)
light_color = Color(0.998012, 0.936827, 0.836428, 1)
light_energy = 1.3

[node name="stationRotator" type="Node3D" parent="PlanetTerrestrial"]

[node name="Station" type="MeshInstance3D" parent="PlanetTerrestrial/stationRotator"]
transform = Transform3D(-0.00747223, -0.000455973, -0.000455973, 0, 0.0053033, -0.0053033, 0.000644843, -0.00528366, -0.00528366, -0.623167, 0.304994, -0.950247)
mesh = ExtResource("4_qum32")
skeleton = NodePath("../../..")

[node name="Camera3D" type="Camera3D" parent="."]
transform = Transform3D(-0.596898, -0.0168643, 0.80214, 0, 0.999779, 0.0210194, -0.802317, 0.0125465, -0.596766, 517.3, 149.996, -462.87)

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
&"": SubResource("AnimationLibrary_tuxge")
}
